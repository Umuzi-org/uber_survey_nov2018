---
title: "Uber driver survey November 2018"
author: "Michelle Hoogenhout"
date: "14 November 2018"
output: html_document
---

# Purpose 
Design a training pilot

# Hypotheses in designing the pilot:

UBER drivers...
- want higher-value economic opportunities / to learn skills
- are interested in digital careers: Trades, digital, business
- have the aptitude for high-value digital careers
- are prepared to study part-time alongside UBER driving long enough to develop employable skills
- are prepared to switch to being an employee or freelancer rather than UBER driver "entrepreneur" on completion of the programme

```{r setup, include=FALSE}

library(tidyverse) #data wrangling
library(magrittr) #pipe
library(ggplot2) #plot
library(scales) #for plotting
library(tm) #word count 
library(tau)

```

```{r functions, include = F}

#get percentage of TRUE observations
getpercentage <- function(var){
 x <- length(which(var == 1))/length(var)*100
 print(round(x,0))
}

#basic bargraph
bargraph <- function(data, x, title = ""){
 p <- ggplot(data, aes(x = x))
 p + geom_bar(aes(y = (..count..)/sum(..count..))) + 
  scale_y_continuous(labels=percent) + 
  labs(x = "", y = "") +
  ggtitle(title) +
  theme(axis.text.x = element_text(angle = 40, size = 16, hjust = 1),
        axis.text.y = element_text(size = 16))
 
}

#export graph
exportgraph <- function(graphname, exportname, width=8, height=6){
 png(filename = exportname, 
     type="cairo",
     units="in", 
     width=width, 
     height=height, 
     pointsize=12, 
     res=96)
 return(graphname)
 dev.off()
 
}

#count number of observations fitting within defined category in a list
countcats <- function(category, list){
 length(grep(paste(category,collapse="|"), 
             list, value=TRUE))
}


#get count of words that occur frequently
wordcount <- function(minfreq, maxfreq, list, removewords){
 
 # Remove Words and Tokenize Text
 skillstext <- textcnt(
  removeWords(scan_tokenizer(list), removewords), 
  method = "string", n = 1L, lower = 1L)
 
 # Change List to Data Frame
 skillsdata <- plyr::ldply(skillstext, data.frame) 
 
 # Filter by occurence
 results <- skillsdata %>%  filter(skillsdata[,2]> minfreq & skillsdata[,2]< maxfreq)
 colnames(results)<-c("word", "frequency")
 
 return(results)
 
}


```


```{r get data}

DATA <- read.csv("clean/alldata.csv")
WILLSTUDY <- read.csv("clean/willstudy_all.csv")

```


## Drivers want higher-value economic opportunities / to learn skills

What percentage of drivers want to study?
Mode and distibution of willingness to spend
Count of certificate, new skill, job

```{r cost outcome willing}

#how many drivers are willing to study?
WillingStudyGraph <- bargraph(DATA, DATA$WillingnessStudy, "Willing to Study Part-Time?")

costlevels <- c("Nothing", "Less than R200", "R200 - R499", 
                "R500 - R999", "R1000 - R1999", "R2000 - R2999")

costgraph <- bargraph(WILLSTUDY, WILLSTUDY$PreferredCost, "Preferred Cost") +
 scale_x_discrete(labels = costlevels)

outcomegraph <- bargraph(WILLSTUDY, WILLSTUDY$DesiredOutcome, "Desired Outcome")

```


## What skills do drivers want to learn?
rank skills offered; group by trade, business, digital, other

```{r skill types}

#List all Skills in vector
temp <- unlist(strsplit(as.character(DATA$Skills), c(",", " and ")))
skillslist <- unlist(strsplit(temp, ","))

#categories
TRADESKILLS = c("Electrical", "Mechanics", "Construction", "Plumbing", "Rigging",
                " Crane operator", "Boiler Maker", "Boiler making", 
                "Oil and gas drilling operations and reading operations")

BUSINESS_SKILLS = c("Entrepreneurship (running your own business)",
                    "Business Studies", "Business strategy", "Project Management",
                    "Financial Accounting", "Accounting", "MBA")

IT_SKILLS = c("Basic computer literacy", "IT", "IT fixing computers,
              Web development", "Data science", "Data engineering", "Programming", 
              "Data analysis")

MARKETING = "Marketing"

skillcats <- list(TRADESKILLS, BUSINESS_SKILLS, IT_SKILLS, MARKETING)


#count skills by category
skillscount <- list()

for (cat in seq_along(skillcats)){
 skillscount[[cat]] <- countcats(skillcats[[cat]], skillslist)
}

#Bind to df
count <- unlist(skillscount)
skill_df <- data.frame(c("Trade", "Business", "IT", "Marketing"), count)
colnames(skill_df) <- c("Category", "Count")

#graph popular skill areas 
SkillGraph <- ggplot(skill_df, aes(Category, Count)) +
 geom_bar(stat = "identity") + 
 ggtitle("Popular skill areas") +
 theme(axis.text.x = element_text(angle = 40, size = 16, hjust = 1),
       axis.text.y = element_text(size = 16)) +
 labs(x = "", y = "Count")

```

```{r}
#Visualise all reported skills

# words not to be counted
removewords <- c("and", "basic", "literacy", "making", 
                 "development", "running", "your", "own", "the", " basic")

skillcount <- wordcount(3,100, skillslist, removewords)

#remove "basic" and strategy
skillcount <- skillcount[-3,]
skillcount <- skillcount[-14,]

#polar coordinates graph of all words
SkillCoord <- ggplot(skillcount, aes(reorder(word, frequency), frequency, fill=word)) + 
 geom_bar(stat = "identity", colour = "black") +
 coord_polar(theta = "x") + xlab("") + ylab("") + 
 ggtitle("Word Frequency: Skills") +
 theme(legend.position = "none",
       axis.text.x = element_text(size = 16, angle=-10),
       axis.text.y = element_text(size = 16)) + 
 labs(x = NULL, y = NULL)

#bargraph
SkillBarGraph <- ggplot(skillcount, aes(reorder(word, frequency), frequency)) +
 geom_bar(stat = "identity", colour = "black") + 
 ggtitle("Word Frequency: Skills") + labs(y = "Frequency", x = "") +
 theme(axis.text.x = element_text(angle = 40, size = 16, hjust = 1),
       axis.text.y = element_text(size = 16))


#bargraph, not cleaned
# Change List to Data Frame
testskills <- plyr::ldply(skillslist, data.frame) 

# Filter by occurence
# tresults <- testskills %>%  filter(testskills[,2]> minfreq & testskills[,2]< maxfreq)
# colnames(tresults)<-c("word", "frequency")
ggplot(skillslist, aes(reorder(word, frequency), frequency)) +
 geom_bar(stat = "identity", colour = "black") + 
 ggtitle("Word Frequency: Skills") + labs(y = "Frequency", x = "") +
 theme(axis.text.x = element_text(angle = 40, size = 16, hjust = 1),
       axis.text.y = element_text(size = 16))

#colourful
plotly::ggplotly(ggplot2::ggplot(skillcount, aes(reorder(word, frequency), frequency, fill=word)) +
                  geom_bar(width = 0.75, stat = "identity", colour = "black", size = 1) + 
                  xlab("") + ylab("") + 
                  ggtitle("Word Frequency") + 
                  theme(legend.position = "none") + 
                  labs(x = NULL, y = NULL) + 
                  theme(plot.subtitle = element_text(vjust = 1), 
                        plot.caption = element_text(vjust = 1), 
                        axis.text.x = element_text(size = 12, angle = 40)) + 
                  theme(panel.background = element_rect(fill = "honeydew1"),
                        plot.background = element_rect(fill = "antiquewhite"))) 

```

## Drivers are prepared to study for long enough to develop skills

```{r willingness to learn, echo = F}

LengthStudyGraph <- bargraph(WILLSTUDY, WILLSTUDY$LengthWillingStudy, "Length Willing to Study")
TimeCommitmentGraph <- bargraph(WILLSTUDY, WILLSTUDY$DailyTimeCommitment, "Daily Time Commitment")
AttendanceGraph <- bargraph(WILLSTUDY, WILLSTUDY$AttendanceFrequency, "Frequency of Attendance")

```


## Drivers have the aptitude to learn new skills


```{r study completion rates, echo = F}

studiedprev <- WILLSTUDY %>% filter(StudiedPreviously == "Yes")

#TODO rename Reasons for not completing levels
barriers = c("Educational support", "Money", "Time", "Started Working", "Prefer not to say", "Personal")

StudiedGraph <- bargraph(WILLSTUDY, WILLSTUDY$StudiedPreviously, "Studied Previously?")

CompletedStudyGraph <- bargraph(studiedprev, studiedprev$CompletedStudies,"Completed Studies?")

NotCompletedStudyGraph <- studiedprev %>% filter(CompletedStudies == "No") %>% 
 ggplot(aes(ReasonNotCompleting)) +
 geom_bar(aes(y = (..count..)/sum(..count..))) + 
 ggtitle("Barriers to Completion") +
 scale_x_discrete(labels = barriers) +
 theme(axis.text.x = element_text(angle=50, size = 14, hjust = 1),
       axis.text.y = element_text(size = 15)) +
 labs(x = "", y = "")

```



What did drivers study before?
```{r}

#polar coordinates graph of all words
PrevStudiesCoord <- ggplot(studiedprev, aes(StudySubject, fill=StudySubject)) + 
 geom_bar(colour = "black") +
 coord_polar(theta = "x") + xlab("") + ylab("") + 
 theme(legend.position = "none",
       axis.text.x = element_text(size = 6, angle=-10)) + 
 labs(x = NULL, y = NULL)

#TODO: merge some categories here

#bargraph
PrevStudiesGraph <- ggplot(studiedprev, aes(StudySubject, fill=StudySubject)) +
 geom_bar(colour = "black") + 
 labs(y = "Frequency", x = "") +
 theme(legend.position = "none",
       axis.text.x = element_text(size = 10),
       axis.text.y = element_text(size = 6)) +
 coord_flip()

```


## Drivers are prepared to switch to employee/ freelancer role

```{r switch position}

SwitchPositionGraph <- bargraph(WILLSTUDY, WILLSTUDY$SwitchPosition, "Prepared to Switch Position")

```


## Drivers have access to computers and internet for self study

Of the drivers surveyed, `r getpercentage(DATA$laptop)` have laptops, `r getpercentage(DATA$HomeInternet)` have internet at home. Most drivers access the internet through their mobile phone. 


```{r laptop internet}

#what percentage of drivers have access to a laptop/pc and internet?

getpercentage(DATA$laptop)
getpercentage(DATA$HomeInternet)
getpercentage(DATA$FriendsPC)


InternetGraph <- bargraph(WILLSTUDY, WILLSTUDY$InternetAccess, "Method of Internet Access")

```

```{r graph export}

graphlist <- list(c(outcomegraph, "figs/Outcome.png"),
                  c(costgraph, "figs/Cost.png"),
                  c(LengthStudyGraph, "figs/LengthStudy.png"),
                  c(LengthStudyGraph, "figs/LengthStudy.png"),
                  c(TimeCommitmentGraph, "figs/TimeCommitment.png"),
                  c(AttendanceGraph, "figs/Attendance.png"),
                  c(StudiedGraph, "figs/StudiedBefore.png"),
                  c(CompletedStudyGraph, "figs/CompletedStudies.png"),
                  c(NotCompletedStudyGraph, "figs/ReasonsNotCompletedStudy.png"),
                  c(SwitchPositionGraph, "figs/SwitchPosition.png"),
                  c(InternetGraph, "figs/InternetAccess.png"))
# 
# for (graph in seq_along(graphlist)){
#   exportgraph(bquote(.(graphlist[graph][1])), bquote(.(graphlist[graph[2]])))
# }

exportgraph(WillingStudyGraph, "figs/WillingToStudy.png")
exportgraph(outcomegraph, "figs/Outcome.png")
exportgraph(costgraph, "figs/Cost.png")
exportgraph(LengthStudyGraph, "figs/LengthStudy.png")
exportgraph(TimeCommitmentGraph, "figs/TimeCommitment.png")
exportgraph(AttendanceGraph, "figs/Attendance.png")
exportgraph(StudiedGraph, "figs/StudiedBefore.png")
exportgraph(CompletedStudyGraph, "figs/CompletedStudies.png")
exportgraph(NotCompletedStudyGraph, "figs/ReasonsNotCompletedStudy.png")
exportgraph(SwitchPositionGraph, "figs/SwitchPosition.png")
exportgraph(InternetGraph, "figs/InternetAccess.png")
exportgraph(SkillGraph, "figs/SkillCategories.png")
exportgraph(SkillCoord, "figs/SkillCategories_polar.png")
exportgraph(SkillBarGraph, "figs/SkillCategoriesAll.png")
exportgraph(PrevStudiesCoord, "figs/PrevStudySubject_coord.png")
exportgraph(PrevStudiesGraph, "figs/PrevStudySubject.png")


dev.off()
```

